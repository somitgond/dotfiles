#+TITLE: My Emacs config
#+AUTHOR: Somit 

* early-init.el
#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;; -*- lexical-binding: t -*-

;; Defer garbage collection
(setq gc-cons-percentage 0.6)

;; Change default max size for reading processes
(setq read-process-output-max (* 1024 1024)) ;; 1mb

(set-language-environment "UTF-8")

;; Set-language-environment sets default-input-method, which is unwanted.
(setq default-input-method nil)

;; Prefer loading newer compiled files
(setq load-prefer-newer t)

;; Prevent the glimpse of un-styled Emacs by disabling these UI elements early.
(setq default-frame-alist
      '((vertical-scroll-bars . nil)
        (menu-bar-lines       . 0)
        (tool-bar-lines       . 0)))

(setq default-frame-scroll-bars 'right)
(setq scroll-bar-mode nil)

;; Resizing the Emacs frame can be a terribly expensive part of changing the
;; font. By inhibiting this, we easily halve startup times with fonts that are
;; larger than the system default.
(setq frame-inhibit-implied-resize t
      frame-resize-pixelwise       t)

;; Font compacting can be very resource-intensive, especially when rendering
;; icon fonts on Windows. This will increase memory usage.
(setq inhibit-compacting-font-caches t)

;; Ignore X resources; its settings would be redundant with the other settings
;; in this file and can conflict with later config (particularly where the
;; cursor color is concerned).
(advice-add #'x-apply-session-resources :override #'ignore)

;; A second, case-insensitive pass over `auto-mode-alist' is time wasted.
;; No second pass of case-insensitive search over auto-mode-alist.
(setq auto-mode-case-fold nil)

;; Disable bidirectional text scanning for a modest performance boost.
(setq-default bidi-display-reordering  'left-to-right
              bidi-paragraph-direction 'left-to-right)

;; Give up some bidirectional functionality for slightly faster re-display.
(setq bidi-inhibit-bpa t)

;; In PGTK, this timeout introduces latency. Reducing it from the default 0.1
;; improves responsiveness of childframes and related packages.
(when (boundp 'pgtk-wait-for-event-timeout)
  (setq pgtk-wait-for-event-timeout 0.001))

;; Disable warnings from the legacy advice API. They aren't useful.
(setq ad-redefinition-action 'accept)

;; Font compacting can be very resource-intensive, especially when rendering
;; icon fonts on Windows. This will increase memory usage.
(setq inhibit-compacting-font-caches t)

;; Unset `file-name-handler-alist' too (temporarily). Every file opened and
;; loaded by Emacs will run through this list to check for a proper handler for
;; the file, but during startup, it wonâ€™t need any of them.
(defvar file-name-handler-alist-old file-name-handler-alist)
(setq file-name-handler-alist nil)
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq file-name-handler-alist file-name-handler-alist-old)))

;; For LSP mode, use plists for deserialization
;; For more info, see https://emacs-lsp.github.io/lsp-mode/page/performance/#use-plists-for-deserialization
(setenv "LSP_USE_PLISTS" "true")

;; Remove "For information about GNU Emacs..." message at startup
(advice-add #'display-startup-echo-area-message :override #'ignore)

;; Suppress the vanilla startup screen completely. Even if disabled with
;; `inhibit-startup-screen', it would still initialize anyway.
(advice-add #'display-startup-screen :override #'ignore)

;; Shave seconds off startup time by starting the scratch buffer in
;; `fundamental-mode'
(setq initial-major-mode 'fundamental-mode
      initial-scratch-message nil)

;; Disable startup screens and messages
(setq inhibit-splash-screen t)

#+END_SRC


* init.el
#+BEGIN_SRC emacs-lisp
        (use-package gcmh
          :config
          (gcmh-mode 1))

        (setq gnutls-algorithm-priority "NORMAL:-VERS-TLS1.3")

        (setq file-name-handler-alist-original file-name-handler-alist)
        (setq file-name-handler-alist nil)

        (setq custom-file (locate-user-emacs-file "custom.el"))
        (load custom-file :no-error-if-file-is-missing)

        ;;; Set up the package manager

        (require 'package)
        (package-initialize)

        (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/"))

        (when (< emacs-major-version 29)
          (unless (package-installed-p 'use-package)
            (unless package-archive-contents
              (package-refresh-contents))
            (package-install 'use-package)))

        (add-to-list 'display-buffer-alist
                     '("\\`\\*\\(Warnings\\|Compile-Log\\)\\*\\'"
                       (display-buffer-no-window)
                       (allow-no-window . t)))

        ;;; Basic behaviour

        (use-package delsel
          :ensure nil
          :hook (after-init . delete-selection-mode))

        (defun prot/keyboard-quit-dwim ()
          "Do-What-I-Mean behaviour for a general `keyboard-quit'.

        The generic `keyboard-quit' does not do the expected thing when
        the minibuffer is open.  Whereas we want it to close the
        minibuffer, even without explicitly focusing it.

        The DWIM behaviour of this command is as follows:

        - When the region is active, disable it.
        - When a minibuffer is open, but not focused, close the minibuffer.
        - When the Completions buffer is selected, close it.
        - In every other case use the regular `keyboard-quit'."
          (interactive)
          (cond
           ((region-active-p)
            (keyboard-quit))
           ((derived-mode-p 'completion-list-mode)
            (delete-completion-window))
           ((> (minibuffer-depth) 0)
            (abort-recursive-edit))
           (t
            (keyboard-quit))))

        (define-key global-map (kbd "C-g") #'prot/keyboard-quit-dwim)

        ;;; Tweak the looks of Emacs

        (let ((mono-spaced-font "Hack Nerd Font Mono")
              (proportionately-spaced-font "Sans"))
          (set-face-attribute 'default nil :family mono-spaced-font :height 130)
          (set-face-attribute 'fixed-pitch nil :family mono-spaced-font :height 1.0)
          (set-face-attribute 'variable-pitch nil :family proportionately-spaced-font :height 1.0))

        (use-package doom-themes
          :ensure t
          :config
          (load-theme 'doom-nord t))

        ;; Remember to do M-x and run `nerd-icons-install-fonts' to get the
        ;; font files.  Then restart Emacs to see the effect.
        (use-package nerd-icons
          :ensure t)

        (use-package nerd-icons-completion
          :ensure t
          :after marginalia
          :config
          (add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup))

        (use-package nerd-icons-corfu
          :ensure t
          :after corfu
          :config
          (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))

        (use-package nerd-icons-dired
          :ensure t
          :hook
          (dired-mode . nerd-icons-dired-mode))

        ;;; Configure the minibuffer and completions

        (use-package vertico
          :ensure t
          :hook (after-init . vertico-mode))

        (use-package marginalia
          :ensure t
          :hook (after-init . marginalia-mode))

        (use-package orderless
          :ensure t
          :config
          (setq completion-styles '(orderless basic))
          (setq completion-category-defaults nil)
          (setq completion-category-overrides nil))

        (use-package savehist
          :ensure nil ; it is built-in
          :hook (after-init . savehist-mode))

        (use-package corfu
          :ensure t
          :hook (after-init . global-corfu-mode)
          :bind (:map corfu-map ("<tab>" . corfu-complete))
          :config
          (setq tab-always-indent 'complete)
          (setq corfu-preview-current nil)
          (setq corfu-min-width 20)

          (setq corfu-popupinfo-delay '(1.25 . 0.5))
          (corfu-popupinfo-mode 1) ; shows documentation after `corfu-popupinfo-delay'

          ;; Sort by input history (no need to modify `corfu-sort-function').
          (with-eval-after-load 'savehist
            (corfu-history-mode 1)
            (add-to-list 'savehist-additional-variables 'corfu-history)))

        ;;; The file manager (Dired)
        (setq display-line-numbers-type 'relative)
        (add-hook 'prog-mode-hook #'display-line-numbers-mode)

        (use-package dired
          :ensure nil
          :commands (dired)
          :hook
          ((dired-mode . dired-hide-details-mode)
           (dired-mode . hl-line-mode))
          :config
          (setq dired-recursive-copies 'always)
          (setq dired-recursive-deletes 'always)
          (setq delete-by-moving-to-trash t)
          (setq dired-dwim-target t))

        (use-package trashed
          :ensure t
          :commands (trashed)
          :config
          (setq trashed-action-confirmer 'y-or-n-p)
          (setq trashed-use-header-line t)
          (setq trashed-sort-key '("Date deleted" . t))
          (setq trashed-date-format "%Y-%m-%d %H:%M:%S"))

        (use-package evil
          :ensure t
          :config
          (evil-mode 1))

        (use-package evil-collection
          :after evil
          :ensure t
          :config
          (evil-collection-init))

        (use-package magit 
          :ensure t)
        (use-package doom-modeline
          :ensure t
          :hook (after-init . doom-modeline-mode))

        (setq-default c-basic-offset 2
                      tab-width 4
                      indent-tabs-mode nil)
      (use-package org-superstar
        :ensure t
        :hook (org-mode . org-superstar-mode))
    (setq org-superstar-remove-leading-stars t)
    (setq org-superstar-special-todo-items t)

(defun my-c-mode-hook ()
  (setq c-basic-offset 2)
  (setq c-default-style "ellemtel")
  (c-set-offset 'substatement-open 0))

(add-hook 'c-mode-hook 'my-c-mode-hook)
(add-hook 'c++-mode-hook 'my-c-mode-hook)

#+END_SRC
